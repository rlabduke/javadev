name: Build Installers

on:
  push:
    tags: ['v*']

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: mac
            ant-target: jpackage-mac
            jogl-os: macosx-universal
            probe-binary: probe
          - os: windows-latest
            platform: win
            ant-target: jpackage-win
            jogl-os: windows-amd64
            probe-binary: probe.exe
          - os: ubuntu-latest
            platform: linux
            ant-target: jpackage-nix
            jogl-os: linux-amd64
            probe-binary: probe

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout KiNG
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Build probe from source
        uses: actions/checkout@v4
        with:
          repository: rlabduke/probe
          path: probe-src

      - name: Compile probe
        run: |
          cd probe-src
          cmake .
          cmake --build . --config Release

      - name: Install probe binary (Unix)
        if: runner.os != 'Windows'
        run: cp probe-src/${{ matrix.probe-binary }} lib/rlab/${{ matrix.platform }}/probe

      - name: Install probe binary (Windows)
        if: runner.os == 'Windows'
        run: copy probe-src\Release\probe.exe lib\rlab\win\probe.exe

      - name: Download JOGL 2.6 natives
        run: |
          curl -sL -o lib/jogl2.6/jogl-all-natives-${{ matrix.jogl-os }}.jar \
            https://repo1.maven.org/maven2/org/jogamp/jogl/jogl-all/2.6.0/jogl-all-2.6.0-natives-${{ matrix.jogl-os }}.jar
          curl -sL -o lib/jogl2.6/gluegen-rt-natives-${{ matrix.jogl-os }}.jar \
            https://repo1.maven.org/maven2/org/jogamp/gluegen/gluegen-rt/2.6.0/gluegen-rt-2.6.0-natives-${{ matrix.jogl-os }}.jar
        shell: bash

      - name: Build KiNG
        run: ant build
        working-directory: king

      - name: Build plugin JARs
        run: |
          ant -f chiropraxis/build.xml build
          ant -f extratools/build.xml build
          ant -f rdcvis/build.xml build

      - name: Extract numeric version for jpackage
        id: version
        run: |
          # Strip 'v' prefix and any non-numeric suffix (e.g. v2.25-rc1 -> 2.25)
          TAG="${GITHUB_REF_NAME#v}"
          NUMERIC="${TAG%%-*}"
          echo "jpackage_version=${NUMERIC}" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Build installer
        run: ant "-Djpackage.version=${{ steps.version.outputs.jpackage_version }}" ${{ matrix.ant-target }}
        working-directory: king
        shell: bash

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: king-installer-${{ matrix.platform }}
          path: king/dist/**/*
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
          generate_release_notes: true
